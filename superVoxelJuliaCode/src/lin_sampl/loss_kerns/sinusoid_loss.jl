using ChainRulesCore, Zygote, CUDA, Enzyme
using KernelAbstractions
using Zygote, Lux
using Lux, Random
import Optimisers, Plots, Random, Statistics, Zygote
using LinearAlgebra
using Revise
using cuTENSOR, TensorOperations, VectorInterface, Test
using LLVMLoopInfo, Dates

includet("/workspaces/superVoxelJuliaCode_lin_sampl/superVoxelJuliaCode/src/lin_sampl/model/util_layers.jl")
includet("/workspaces/superVoxelJuliaCode_lin_sampl/superVoxelJuliaCode/src/lin_sampl/sv_points/initialize_sv.jl")

"""
We want to use here the point coordinates and interpolated values calculated for each supervoxel
we will use it as an imput to couple tensor layers and use them to generate parameters for sinusoids 
that will be used as approximation of current texture - we will purposfully restrict those sinusoids to high frequency 
to make sure that we are able to capture the texture of the image but not edges
we need to  
1) reshape the outsampled points to work per supervoxel
2) apply tensor operations and non linearities to get the parameters for sinusoids
3) apply sinusoids to the points and calculate the weighted squared diffrence between evaluated value of sinusoids 
    and interpolated value
4) calculate the mean of those differences and return it as a loss    
"""

# function evaluate_sinusoid(angles::Tuple{Float64, Float64, Float64}, wavelength::Float64, offsets::Tuple{Float64, Float64, Float64}, x::Float64, y::Float64, z::Float64)::Float64
#     alpha, beta, gamma = angles
#     offset_x, offset_y, offset_z = offsets

#     # Apply offsets to coordinates
#     x = x + offset_x
#     y = y + offset_y
#     z = z + offset_z

#     # Compute the sinusoidal function
#     sinusoid_value = sin(2 * π / wavelength * (x * cos(alpha) + y * cos(beta) + z * cos(gamma)))

#     return sinusoid_value
# end



"""
given out sampled points and parameters of sinusoids (sin_p) it will calculate the loss of the sinusoids
so it will compare the value of sinusoids with the interpolated values and calculate the weighted mean of squared differences
using weights in out sampled points
sin_p - parameters of sinusoids first dim is sv index second sinusoid index, third sinusoid weights - first 3 angles, 4 wavelength, 5,6,7 offset 8 base 9 amplitude
max_wavelength - maximum wavelength of sinusoids
max_amplitude - maximum amplitude of sinusoids
min_value - subtracted from the result to enable results to be more negative if needed

num_texture_banks,num_sinusoids_per_bank - needs to be defined as constants at compile time

blockIdx().y - index of supervoxel 
index - index of point in supervoxel

blockIdx().z - index of batch
"""

function get_sinusoid_loss(out_sampled_points, sin_p, texture_bank_p, out_res, max_wavelength, max_amplitude, min_value, max_index, texture_bank_begin_index)

  shared_arr = CuStaticSharedArray(Float32, (256, 3))
  #saving 1) offset_x, 2) offset_y, 3) offset_z  4)bias 5) multiplier for current supervoxel
  shared_arr_b = CuStaticSharedArray(Float32, (5))

  if (threadIdx().x <= 5)
    shared_arr_b[threadIdx().x] = sin_p[blockIdx().y, threadIdx().x, blockIdx().z]
  end

  #  index = (threadIdx().x + ((blockIdx().x - 1) * CUDA.blockDim_x()))
  if ((threadIdx().x + ((blockIdx().x - 1) * CUDA.blockDim_x())) > max_index)
    return nothing
  end
  sync_threads()
  shared_arr[threadIdx().x, 1] = (out_sampled_points[blockIdx().y, (threadIdx().x+((blockIdx().x-1)*CUDA.blockDim_x())), 3, blockIdx().z] + (shared_arr_b[1] * max_wavelength))
  shared_arr[threadIdx().x, 2] = (out_sampled_points[blockIdx().y, (threadIdx().x+((blockIdx().x-1)*CUDA.blockDim_x())), 4, blockIdx().z] + (shared_arr_b[2] * max_wavelength))
  shared_arr[threadIdx().x, 3] = (out_sampled_points[blockIdx().y, (threadIdx().x+((blockIdx().x-1)*CUDA.blockDim_x())), 5, blockIdx().z] + (shared_arr_b[3] * max_wavelength))

  # adding values from all sigmoids as their combined functions constitute function approximation of the texture
  # @loopinfo unroll for t in 1 : num_texture_banks
  #     @loopinfo unroll for sin_i in 1:num_sinusoids_per_bank

  # x -out_sampled_points[blockIdx().y, index, 3, blockIdx().z]
  # y -out_sampled_points[blockIdx().y, index, 4, blockIdx().z]
  # z -out_sampled_points[blockIdx().y, index, 5, blockIdx().z]
  #p=sin_p[index,sin_i,:,blockIdx().z]
  # alpha=p[1]*2*π
  # beta=p[2]*2*π
  # gamma=p[3]*2*π
  # wavelength=p[4]*max_wavelength
  # offset_x=p[5]*max_wavelength
  # offset_y=p[6]*max_wavelength
  # offset_z=p[7]*max_wavelength
  # base=p[8] *max_amplitude
  # amplitude=p[9]*max_amplitude

  # sin(2 * π / p[4] * ((x+p[5]) * cos(p[1]) + (y+p[6]) * cos(p[2]) + (z+p[7]) * cos(p[3])))+p[8]

  # sin(2 * π / p[4] * ((x+p[5]) * cos(p[1]) + (y+p[6]) * cos(p[2]) + (z+p[7]) * cos(p[3])))+p[8]
  #each weight is between 0 and 1 becouse sigmoid is last layer in layers to get sinusoid weights
  #so in case of all angls we multiply it by 2π
  #in case of offsets and wavelenths we multiply by max_wavelength



  # #saving accumulated loss values divided by sum of weights
  out_res[blockIdx().y, (threadIdx().x+((blockIdx().x-1)*CUDA.blockDim_x())), blockIdx().z] = (
    (((sin(2 * π / (texture_bank_p[1+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
           * ((shared_arr[threadIdx().x, 1])
            * cos(texture_bank_p[1+texture_bank_begin_index, 1, 1] * 2 * π)
            + (shared_arr[threadIdx().x, 2])
              * cos(texture_bank_p[1+texture_bank_begin_index, 1, 2] * 2 * π)
            + (shared_arr[threadIdx().x, 3])
              * cos(texture_bank_p[1+texture_bank_begin_index, 1, 3] * 2 * π)))
       * (texture_bank_p[1+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 1+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[1+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                    * cos(texture_bank_p[1+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                      * cos(texture_bank_p[1+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                      * cos(texture_bank_p[1+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                               * (texture_bank_p[1+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 1+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[1+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                            * cos(texture_bank_p[1+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                              * cos(texture_bank_p[1+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                              * cos(texture_bank_p[1+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                       * (texture_bank_p[1+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 1+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[1+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[1+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[1+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[1+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[1+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 1+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[2+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[2+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[2+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[2+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[2+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 2+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[2+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[2+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[2+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[2+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[2+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 2+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[2+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[2+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[2+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[2+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[2+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 2+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[2+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[2+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[2+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[2+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[2+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 2+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[3+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[3+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[3+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[3+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[3+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 3+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[3+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[3+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[3+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[3+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[3+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 3+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[3+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[3+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[3+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[3+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[3+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 3+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[3+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[3+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[3+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[3+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[3+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 3+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[4+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[4+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[4+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[4+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[4+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 4+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[4+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[4+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[4+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[4+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[4+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 4+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[4+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[4+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[4+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[4+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[4+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 4+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[4+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[4+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[4+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[4+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[4+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 4+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[5+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[5+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[5+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[5+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[5+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 5+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[5+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[5+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[5+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[5+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[5+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 5+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[5+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[5+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[5+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[5+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[5+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 5+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[5+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[5+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[5+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[5+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[5+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 5+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[6+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[6+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[6+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[6+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[6+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 6+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[6+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[6+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[6+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[6+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[6+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 6+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[6+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[6+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[6+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[6+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[6+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 6+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[6+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[6+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[6+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[6+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[6+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 6+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[7+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[7+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[7+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[7+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[7+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 7+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[7+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[7+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[7+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[7+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[7+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 7+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[7+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[7+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[7+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[7+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[7+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 7+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[7+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[7+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[7+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[7+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[7+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 7+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[8+texture_bank_begin_index, 1, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[8+texture_bank_begin_index, 1, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[8+texture_bank_begin_index, 1, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[8+texture_bank_begin_index, 1, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[8+texture_bank_begin_index, 1, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 8+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[8+texture_bank_begin_index, 2, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[8+texture_bank_begin_index, 2, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[8+texture_bank_begin_index, 2, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[8+texture_bank_begin_index, 2, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[8+texture_bank_begin_index, 2, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 8+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[8+texture_bank_begin_index, 3, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            * cos(texture_bank_p[8+texture_bank_begin_index, 3, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[8+texture_bank_begin_index, 3, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * cos(texture_bank_p[8+texture_bank_begin_index, 3, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * (texture_bank_p[8+texture_bank_begin_index, 3, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 8+texture_bank_begin_index+5, blockIdx().z])) + (((sin(2 * π / (texture_bank_p[8+texture_bank_begin_index, 4, 4] * max_wavelength)#wavelength
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * ((shared_arr[threadIdx().x, 1])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    * cos(texture_bank_p[8+texture_bank_begin_index, 4, 1] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[8+texture_bank_begin_index, 4, 2] * 2 * π)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + (shared_arr[threadIdx().x, 3])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * cos(texture_bank_p[8+texture_bank_begin_index, 4, 3] * 2 * π)))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               * (texture_bank_p[8+texture_bank_begin_index, 4, 5] * max_amplitude) * ((shared_arr_b[5] * 2) + 0.5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + (shared_arr_b[4] * max_amplitude) - min_value) * (sin_p[blockIdx().y, 8+texture_bank_begin_index+5, blockIdx().z]))
  )

  return nothing
end


function get_sinusoid_loss_deff(out_sampled_points, d_out_sampled_points, sin_p, d_sin_p, texture_bank_p, d_texture_bank_p, out_res, d_out_res, max_wavelength, max_amplitude, min_value, max_index, texture_bank_begin_index)

  Enzyme.autodiff_deferred(Enzyme.Reverse, Enzyme.Const(get_sinusoid_loss), Const, Duplicated(out_sampled_points, d_out_sampled_points), Duplicated(sin_p, d_sin_p),
    Duplicated(texture_bank_p, d_texture_bank_p),
    Duplicated(out_res, d_out_res), Const(max_wavelength), Const(max_amplitude), Const(min_value), Const(max_index), Const(texture_bank_begin_index)
  )
  return nothing
end

function call_get_sinusoid_loss(out_sampled_points, sin_p, texture_bank_p, max_wavelength, max_amplitude, min_value, texture_bank_begin_index)

  blocks_x = Int(ceil(size(out_sampled_points, 2) / 256))
  max_index = size(out_sampled_points, 2)
  batch_size = size(out_sampled_points)[end]
  out_res = CUDA.zeros(size(out_sampled_points, 1), size(out_sampled_points, 2), batch_size)#first and last dimension where last dimension is batch
  @cuda threads = (256,) blocks = (blocks_x, size(out_sampled_points, 1), batch_size) get_sinusoid_loss(out_sampled_points, sin_p, texture_bank_p, out_res, max_wavelength, max_amplitude, min_value, max_index, texture_bank_begin_index)


  return out_res
end


function ChainRulesCore.rrule(::typeof(call_get_sinusoid_loss), out_sampled_points, sin_p, texture_bank_p, max_wavelength, max_amplitude, min_value, texture_bank_begin_index)

  out_res = call_get_sinusoid_loss(out_sampled_points, sin_p, texture_bank_p, max_wavelength, max_amplitude, min_value, texture_bank_begin_index)

  function call_test_kernel1_pullback(d_out_res)
    #@device_code_warntype 
    current_time = Dates.now()

    d_out_res = CuArray(Zygote.unthunk(d_out_res))
    d_out_sampled_points = CUDA.zeros(size(out_sampled_points)...)

    d_sin_p = CUDA.zeros(size(sin_p)...)
    d_texture_bank_p = CUDA.zeros(size(texture_bank_p)...)

    blocks_x = size(out_sampled_points)[1]
    batch_size = size(out_sampled_points)[end]
    max_index = size(out_sampled_points, 2)

    @cuda threads = (256,) blocks = (blocks_x, size(out_sampled_points, 1), batch_size) get_sinusoid_loss_deff(out_sampled_points, d_out_sampled_points, sin_p, d_sin_p, texture_bank_p, d_texture_bank_p, out_res, d_out_res, max_wavelength, max_amplitude, min_value, max_index, texture_bank_begin_index)

    oss = sum(d_out_sampled_points)
    seconds_diff = Dates.value(Dates.now() - current_time) / 1000
    print("\n sinusoid loss back  oss $(oss); $(seconds_diff) sec ")
    #   @info "Time taken for sinusoid loss back : $(st.ex)  " times=round(seconds_diff; digits = 2)

    return NoTangent(), d_out_sampled_points, d_sin_p, d_texture_bank_p, NoTangent(), NoTangent(), NoTangent(), NoTangent()
  end

  return out_res, call_test_kernel1_pullback

end


###### helper layer just select first from tuple (out_sampled points, tetr_dat)

struct Select_from_Tuple_str <: Lux.AbstractLuxLayer
end

function Lux.initialparameters(rng::AbstractRNG, l::Select_from_Tuple_str)
  return (a=1,) #dummy variable
end

function Lux.initialstates(::AbstractRNG, l::Select_from_Tuple_str)::NamedTuple
  return (b=1,) #dummy variable
end

function (l::Select_from_Tuple_str)(x, ps, st::NamedTuple)

  return x[1], st
end
####### wrapping sinusoid loss in lux layer

struct Sinusoid_loss_str <: Lux.AbstractLuxLayer
  num_base_samp_points::Int
  num_additional_samp_points::Int
  max_wavelength::Float32
  max_amplitude::Float32
  min_value::Float32
  num_sinusoids_per_bank::Int
  num_texture_banks::Int

end

function Lux.initialparameters(rng::AbstractRNG, l::Sinusoid_loss_str)
  return (texture_bank_p=rand(Float32, l.num_texture_banks, l.num_sinusoids_per_bank, 5),)
end

function Lux.initialstates(::AbstractRNG, l::Sinusoid_loss_str)::NamedTuple
  num_texture_banks = l.num_texture_banks

  @assert num_texture_banks % 8 == 0 "num_texture_banks must be divisible by 8"
  @assert num_texture_banks >= 16 "num_texture_banks must be at least 16"

  return (num_base_samp_points=l.num_base_samp_points, num_additional_samp_points=l.num_additional_samp_points, max_wavelength=l.max_wavelength, max_amplitude=l.max_amplitude, min_value=l.min_value, num_sinusoids_per_bank=l.num_sinusoids_per_bank, num_texture_banks=l.num_texture_banks)
end


"""
get out sampled points and sinusoid loss tensor and return weighted mean of sinusoid loss
and weighted mean of out sampled points (second for example used for visualization) - both values are per sv and per batch
"""
function get_mean_and_reduction(out_sampled_points, sin_loss_arr, num_additional_samp_points, num_base_samp_points, batch_size, num_sv)
  sizz_out = size(out_sampled_points)
  n_points_per_tetr = num_base_samp_points + (3 * num_additional_samp_points)
  num_sv = sizz_out[1]

  values_big = reshape(out_sampled_points[:, :, :, 1, :], num_sv, sizz_out[2] * sizz_out[3], batch_size)
  weights_big = reshape(out_sampled_points[:, :, :, 2, :], num_sv, sizz_out[2] * sizz_out[3], batch_size)

  big_weighted_values = values_big .* weights_big
  big_weighted_values_summed = sum(big_weighted_values, dims=2)

  big_weights_sum = sum(weights_big, dims=2)

  big_mean_weighted = big_weighted_values_summed ./ big_weights_sum


  sin_loss_arr = sin_loss_arr .- values_big
  sin_loss_arr = sin_loss_arr .^ 2

  weighted_sin_loss = sin_loss_arr .* weights_big
  weighted_sin_loss = sum(weighted_sin_loss, dims=2)
  weighted_sin_loss = weighted_sin_loss ./ big_weights_sum

  return big_mean_weighted, weighted_sin_loss
end


function (l::Sinusoid_loss_str)(x, ps, st::NamedTuple)

  #    current_time = Dates.now()

  out_sampled_points, tetr_dat, sin_p = x
  sin_p_a = sin_p[:, 1:5, :]
  sin_p_b = softmax(sin_p[:, 6:end, :], dims=2)
  sin_p = cat(sin_p_a, sin_p_b, dims=2)
  max_wavelength = st.max_wavelength
  max_amplitude = st.max_amplitude
  min_value = st.min_value

  new_siz = size(out_sampled_points)


  out_sampled_points_reshaped = reshape(out_sampled_points, new_siz[1], new_siz[2] * new_siz[3], 5, new_siz[end])

  texture_bank_begin_index = 0
  sin_loss_arr = call_get_sinusoid_loss(out_sampled_points_reshaped, sin_p, ps.texture_bank_p, max_wavelength, max_amplitude, min_value, texture_bank_begin_index)

  for i in 1:(Int(round(st.num_texture_banks / 8))-1)
    texture_bank_begin_index = texture_bank_begin_index + 8
    sin_loss_arr += call_get_sinusoid_loss(out_sampled_points_reshaped, sin_p, ps.texture_bank_p, max_wavelength, max_amplitude, min_value, texture_bank_begin_index)
  end

  big_mean_weighted, weighted_sin_loss = get_mean_and_reduction(out_sampled_points, sin_loss_arr, st.num_additional_samp_points, st.num_base_samp_points, new_siz[end], new_siz[1])


  # seconds_diff = Dates.value(Dates.now() - current_time)/ 1000
  #  @info "sinusoid loss forward total " times=round(seconds_diff; digits = 2) 
  # print(" \n sinusoid loss forward total : $seconds_diff sec \n ")

  return (big_mean_weighted, weighted_sin_loss, tetr_dat, sin_p, ps.texture_bank_p), st
end



############### all layers after points kern together

function connection_before_loss(x, y)
  out_sampled_points, tetr_dat = y
  # print("\n in connection out_sampled_points $(typeof(out_sampled_points)) tetr_dat $(typeof(tetr_dat)) y $(typeof(y))  \n")

  return out_sampled_points, tetr_dat, x
end #connection_before_set_tetr_dat_kern

"""
get weights needed to calculate weights from sinusoids
t_size is size(tetr_dat)[1]
num_sinusoids is the number of sinusoids we want to use to approximate the texture
weights_per_sinusoid - how many weights each sinusoid need - generally 5 in typical case
It requires the shape where the second dimension to be the number of tetrahedrons in the super voxel so as it is in get_per_sv_variance
"""
function get_sinusoid_loss_layers(num_base_samp_points, num_additional_samp_points, t_size, is_point_per_triangle, max_wavelength::Float32, max_amplitude::Float32, min_value::Float32, num_texture_banks::Int, num_sinusoids_per_bank::Int, nn2=8, p2=8, nn3=8, svn2=10, svn3=10, p3=10, svn4=10, p4=10)

  nn = num_base_samp_points + (3 * num_additional_samp_points)
  #input(t_size/get_num_tetr_in_sv(),get_num_tetr_in_sv(),nn,5,batch_size)
  svn = get_num_tetr_in_sv(is_point_per_triangle)
  t = Int(round(t_size / svn))
  ww = num_texture_banks + 5

  return [
    Lux.SkipConnection(
      layers=Lux.Chain(Select_from_Tuple_str(),
        TensorOpLayer_str((nn, 5, nn2, p2), :(res[t, svn, nn2, p2, b] := x[t, svn, nn, p, b] * ps.P[nn, p, nn2, p2])), Lux.LayerNorm((t, svn, nn2, p2)), TensorOpLayer_str((nn2, svn, svn2, nn3), :(res[t, svn2, nn3, p2, b] := x[t, svn, nn2, p2, b] * ps.P[nn2, svn, svn2, nn3])), Lux.LayerNorm((t, svn2, nn3, p2)), TensorOpLayer_str((svn2, p2, svn3, p3), :(res[t, svn3, nn3, p3, b] := x[t, svn2, nn3, p2, b] * ps.P[svn2, p2, svn3, p3])), Lux.LayerNorm((t, svn3, nn3, p3)), TensorOpLayer_str((svn4, p4, svn3, p3), :(res[t, svn4, nn3, p4, b] := x[t, svn3, nn3, p3, b] * ps.P[svn4, p4, svn3, p3])), Lux.LayerNorm((t, svn4, nn3, p4)), TensorOpLayer_str((svn4, nn3, p4, ww), :(res[t, ww, b] := x[t, svn4, nn3, p4, b] * ps.P[svn4, nn3, p4, ww]), "sigm")
      ), connection=connection_before_loss), Sinusoid_loss_str(num_base_samp_points, num_additional_samp_points, max_wavelength, max_amplitude, min_value, num_sinusoids_per_bank, num_texture_banks)
  ]

end

